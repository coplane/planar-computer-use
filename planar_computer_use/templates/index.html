<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNC Automation</title>
    <style>
        body { font-family: sans-serif; margin: 20px; display: flex; gap: 20px; }
        .controls, .viewer { border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
        .controls div { margin-bottom: 10px; width: 600px; }
        label { display: inline-block; width: 100px; }
        input[type="text"], input[type="number"], input[type="password"] { width: 150px; padding: 5px; }
        button { padding: 8px 12px; cursor: pointer; }
        #vncScreen { border: 1px solid black; max-width: 800px; max-height: 600px; background-color: #f0f0f0; }
        #status { margin-top: 10px; font-style: italic; color: #555; }
        .log-area { margin-top: 15px; height: 100px; overflow-y: scroll; border: 1px solid #eee; padding: 5px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="controls">
        <h2>VNC Control</h2>
        
        <div>
            <label for="vncHost">Host:</label>
            <input type="text" id="vncHost" value="10.0.204.205">
        </div>
        <div>
            <label for="vncPort">Port:</label>
            <input type="number" id="vncPort" value="5901">
        </div>
        <div>
            <label for="vncPassword">Password:</label>
            <input type="password" id="vncPassword" value="123456">
        </div>
        <button onclick="connectVNC()">Connect</button>
        <button onclick="disconnectVNC()">Disconnect</button>
        <button onclick="checkStatus()">Check Status</button>
        
        <hr>
        <h3>Interactions (Requires Connection)</h3>
        <div>
            <label for="clickX">Click X:</label>
            <input type="number" id="clickX" value="100">
        </div>
        <div>
            <label for="clickY">Click Y:</label>
            <input type="number" id="clickY" value="100">
        </div>
        <button onclick="sendClick()">Send Click (Left)</button>
        
        <div>
            <label for="typeText">Type Text:</label>
            <input type="text" id="typeText" value="Hello VNC!">
        </div>
        <button onclick="sendType()">Send Type</button>

        <hr>
        <button onclick="getSingleScreenshot()">Get Single Screenshot</button>
        <div id="status">Not connected.</div>
        <div class="log-area" id="logArea"></div>
    </div>

    <div class="viewer">
        <h2>VNC Viewer (Stream)</h2>
        <img id="vncScreen" width="800" height="600" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="VNC Screen Stream">
        <p><em>Click on the image to get coordinates relative to the image.</em></p>
        <p>Image Click Coords: <span id="imageCoords">N/A</span></p>
    </div>

    <script>
        const vncHostInput = document.getElementById('vncHost');
        const vncPortInput = document.getElementById('vncPort');
        const vncPasswordInput = document.getElementById('vncPassword');
        const clickXInput = document.getElementById('clickX');
        const clickYInput = document.getElementById('clickY');
        const typeTextInput = document.getElementById('typeText');
        const vncScreenImg = document.getElementById('vncScreen');
        const statusDiv = document.getElementById('status');
        const logArea = document.getElementById('logArea');
        const imageCoordsSpan = document.getElementById('imageCoords');

        let eventSource = null;
        let isConnected = false;

        function logMessage(message, isError = false) {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (isError) entry.style.color = 'red';
            logArea.insertBefore(entry, logArea.firstChild);
        }

        async function apiCall(endpoint, method = 'POST', body = null) {
            try {
                const options = {
                    method: method,
                    headers: {'Content-Type': 'application/json'}
                };
                if (body) options.body = JSON.stringify(body);
                
                const response = await fetch(endpoint, options);
                const data = await response.json();

                if (!response.ok) {
                    logMessage(`Error: ${data.detail || response.statusText}`, true);
                    throw new Error(data.detail || response.statusText);
                }
                logMessage(`${method} ${endpoint}: ${data.message || JSON.stringify(data)}`);
                return data;
            } catch (error) {
                logMessage(`Network/API Error: ${error.message}`, true);
                throw error; // Re-throw for caller to handle if needed
            }
        }

        async function connectVNC() {
            const host = vncHostInput.value;
            const port = parseInt(vncPortInput.value);
            const password = vncPasswordInput.value || null; // Send null if empty for Pydantic

            try {
                await apiCall('/api/vnc/connect', 'POST', { host, port, password });
                statusDiv.textContent = `Connecting to ${host}:${port}...`;
                startStreaming(); // Start stream on successful connect call
                await checkStatus(); // Update status after connect attempt
            } catch (error) {
                // Error already logged by apiCall
                statusDiv.textContent = `Connection failed.`;
                isConnected = false;
            }
        }

        async function disconnectVNC() {
            try {
                await apiCall('/api/vnc/disconnect', 'POST');
                statusDiv.textContent = 'Disconnected.';
                stopStreaming();
                vncScreenImg.src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="; // Clear image
                isConnected = false;
            } catch (error) {
                // Error already logged
            }
        }

        async function checkStatus() {
            try {
                const data = await apiCall('/api/vnc/status', 'GET');
                isConnected = data.connected;
                if (isConnected) {
                    statusDiv.textContent = `Connected to ${data.host}:${data.port}.`;
                    if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
                        startStreaming(); // Restart stream if needed and connected
                    }
                } else {
                    statusDiv.textContent = 'Not connected.';
                    stopStreaming();
                }
            } catch (error) {
                statusDiv.textContent = 'Error checking status.';
                isConnected = false;
            }
        }


        async function sendClick() {
            if (!isConnected) {
                logMessage('Cannot send click: Not connected.', true);
                alert('Not connected to VNC. Please connect first.');
                return;
            }
            const x = parseInt(clickXInput.value);
            const y = parseInt(clickYInput.value);
            try {
                await apiCall('/api/vnc/click', 'POST', { x, y, button: 1 });
            } catch (error) { /* Already logged */ }
        }

        async function sendType() {
             if (!isConnected) {
                logMessage('Cannot send type: Not connected.', true);
                alert('Not connected to VNC. Please connect first.');
                return;
            }
            const text = typeTextInput.value;
            try {
                await apiCall('/api/vnc/type', 'POST', { text });
            } catch (error) { /* Already logged */ }
        }

        async function getSingleScreenshot() {
            if (!isConnected) {
                logMessage('Cannot get screenshot: Not connected.', true);
                alert('Not connected to VNC. Please connect first.');
                return;
            }
            try {
                const data = await apiCall('/api/vnc/screenshot', 'GET');
                // Display it somewhere, or just log for now
                // For example, you could open it in a new tab/window:
                // window.open(data.screenshot_base64, '_blank');
                logMessage('Single screenshot received (see console or open in new tab).');
                // For LLM, you'd send data.screenshot_base64 to your model
                console.log("Single Screenshot B64:", data.screenshot_base64);
            } catch (error) { /* Already logged */ }
        }

        function startStreaming() {
            if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
                logMessage('Stream already active.');
                return;
            }

            logMessage('Starting VNC screen stream...');
            eventSource = new EventSource('/api/vnc/stream');

            eventSource.onmessage = function(event) {
                if (event.data) {
                    vncScreenImg.src = event.data;
                }
            };
            
            eventSource.addEventListener('status', function(event) {
                const statusData = JSON.parse(event.data);
                logMessage(`Stream status: ${statusData.message}`);
                if (!statusData.connected) {
                    isConnected = false;
                    statusDiv.textContent = 'VNC Disconnected (reported by stream).';
                    // Optionally stop the stream if VNC is reported disconnected
                    // stopStreaming(); 
                }
            });

            eventSource.onerror = function(error) {
                logMessage('EventSource error. Stream might be closed or server unavailable.', true);
                console.error("EventSource failed:", error);
                statusDiv.textContent = 'Stream connection error.';
                stopStreaming(); // Stop and allow manual reconnect/check status
                isConnected = false; // Assume disconnected on stream error
            };
            // Check initial status
            checkStatus();
        }

        function stopStreaming() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                logMessage('VNC screen stream stopped.');
            }
        }
        
        vncScreenImg.addEventListener('click', function(event) {
            const rect = vncScreenImg.getBoundingClientRect();
            // Calculate scale factors if the displayed image is scaled
            const scaleX = vncScreenImg.naturalWidth / vncScreenImg.offsetWidth;
            const scaleY = vncScreenImg.naturalHeight / vncScreenImg.offsetHeight;

            // Coordinates relative to the displayed image element
            const displayX = event.clientX - rect.left;
            const displayY = event.clientY - rect.top;
            
            // Scale to original image coordinates
            const originalX = Math.round(displayX * scaleX);
            const originalY = Math.round(displayY * scaleY);

            clickXInput.value = originalX;
            clickYInput.value = originalY;
            imageCoordsSpan.textContent = `Display: (${Math.round(displayX)}, ${Math.round(displayY)}), Original: (${originalX}, ${originalY})`;
        });

        // Initial status check
        window.onload = checkStatus;
    </script>
</body>
</html>
